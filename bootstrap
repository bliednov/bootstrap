#!/usr/bin/env bash

set -euo pipefail

dotfiles_dir=~/.dotfiles
os=`uname`
is_linux=$([[ $os == "Linux" ]] && echo $?)
is_darwin=$([[ $os == "Darwin" ]] && echo $?)
supported_linux_distrib_id="Ubuntu"
supported_linux_distrib_release="20.04"

check_os() {
    [[ $is_darwin ]] && return 0
    [[ $is_linux ]] && $(. /etc/lsb-release && [[ $DISTRIB_ID == $supported_linux_distrib_id && $DISTRIB_RELEASE == $supported_linux_distrib_release ]]) && return 0
    [[ ! $is_linux ]] && echo "Unsupported OS: $os"
    [[ $is_linux ]] && $(. /etc/lsb-release && echo "Unsupported Linux distribution: $DESTRIB_DESCRIPTION")
    echo "Supported: Darwin/Linux($supported_linux_distrib_id $supported_linux_distrib_release)"
    exit 1
}

install_homebrew() {
    [[ `command -v brew` ]] && return 0
    [[ $is_linux && `ls /home/linuxbrew/.linuxbrew/bin/brew &>/dev/null` ]] && return 0
    [[ $is_linux ]] && sudo apt update && sudo apt upgrade -y
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    [[ $is_linux ]] && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
}

install_gcloud() {
    [[ $is_darwin ]] && brew install --cask google-cloud-sdk
    [[ $is_linux ]] && sudo snap install google-cloud-sdk --classic
}

signin_gcloud() {
    read -p "Email:" gcloud_email
    read -p "Project:" gcloud_project
    gcloud auth login --account=$gcloud_email
    gcloud init --console-only --account=$gcloud_email --configuration=default --project=$gcloud_project
}

setup_gcloud() {
    while true; do
	read -p "Do you wish to initialize gcloud? (y/n):" yn
        case $yn in
            [Yy]* ) signin_gcloud;;
            [Nn]* ) return;;
            * ) echo "Please answer yes or no.";;
        esac
    done
}

sync_dotfiles_repo() {
    echo "Syncing the dotfiles repo"
    if test -d $dotfiles_dir
    then
        (cd $dotfiles_dir; git fetch --all; git pull origin master --ff-only)
    else
        gcloud source repos clone dotfiles $dotfiles_dir
    fi
}

initialize_dotfiles() {
    sync_dotfiles_repo
    (cd $dotfiles_dir; ./install)
}

setup_dotfiles() {
    while true; do
	read -p "Do you wish to initialize dotfiles? (y/n):" yn
        case $yn in
            [Yy]* ) initialize_dotfiles;;
            [Nn]* ) return;;
            * ) echo "Please answer yes or no.";;
        esac
    done
}

check_os
install_homebrew
install_gcloud
setup_gcloud
sync_dotfiles_repo
setup_dotfiles
